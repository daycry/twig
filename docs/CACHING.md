# Twig Caching & Persistence Architecture for CodeIgniter 4

This document explains every caching/persistence layer implemented in this library: what it stores, how it is keyed, when it is read/written, and how to clear or tune it.

> Summary: There are **five** persistence domains plus **one optional acceleration layer (APCu)**
> 1. Compiled template bytecode (Twig compiled PHP classes)
> 2. Compile Index (logical template -> compiled flag map)
> 3. Template Discovery statistics & (optionally) full template list snapshot
> 4. Warmup summary state
> 5. Invalidation history (last + cumulative)
> 6. (Optional) APCu list cache for discovery list reuse across PHP processes

All artifacts can live either on the filesystem (default) or inside the **CodeIgniter cache service** (Redis / Memcached / etc.) when `cacheBackend = 'ci'` is configured.

---
## 1. Compiled Template Cache
Compiled templates are PHP classes generated by Twig. Two backends:

| Backend | Storage | Config Switch | Clearing Mechanism |
|---------|---------|---------------|--------------------|
| File (default) | Files under `WRITEPATH/cache/twig` (or custom `cachePath`) | `cacheBackend = 'file'` (default) | Delete *.php files (handled by `clearCache()`) |
| CI Cache | Entries in configured CI cache handler (Redis/Memcached...) | `cacheBackend = 'ci'` | `CICacheAdapter::clear()` deletes all keys listed in its index |

### File Backend
Twig creates one PHP file per compiled template. Filenames include an md5 segment of the logical template name + environment salt. We heuristically detect compiled presence with `md5(<logical>.twig)` substring scanning during warmup or invalidation.

### CI Cache Backend
Implemented via `CICacheAdapter` (implements `Twig\Cache\CacheInterface`). Each compiled template is stored as a JSON payload:
```json
{"t": <unix_timestamp>, "c": "<?php class ... >" }
```
Key format: `<prefix><sha256(className::logicalName)>`

An index key `<prefix>__index` tracks all compiled keys for full clear operations. Prefix is configurable; see section 6.

---
## 2. Compile Index (`compile-index.json` or CI key)
Purpose: Quickly know which logical templates have been compiled without scanning directories.

Stored as simple JSON mapping:
```json
{ "emails/welcome": true, "dashboard/index": true }
```

| Backend | Location / Key | When Written | When Read |
|---------|----------------|--------------|-----------|
| File | `<cachePath>/compile-index.json` | After warmup or successful invalidation removals | On first need (lazy) for listing / warmup |
| CI Cache | `<prefix>compile.index` | Same triggers | Same (lazy) |

Used by:
- Warmup (skip already compiled unless `--force`)
- `listTemplates(true)` for compiled status
- Diagnostics panel / CLI stats

---
## 3. Template Discovery Persistence
The discovery process enumerates all logical template names by walking each configured template directory (namespaced & root). To avoid repeated filesystem traversal:

Artifacts:
- Stats JSON (hits, misses, invalidations, persisted fingerprint)
- Optional snapshot of the full template list + fingerprint

Config controls in `Config\Twig`:
```php
public bool $discoveryPersistList = false;   // Persist list snapshot
public bool $discoveryPreload     = false;   // Preload snapshot on new request
public bool $discoveryUseAPCu     = false;   // Store list in APCu (if available)
public int  $discoveryFingerprintMtimeDepth = 0; // Dir mtime sampling depth
```

### Fingerprinting Strategy
A stable SHA-1 fingerprint is built from:
1. Canonicalized namespace/path map (sorted, realpath-normalized)
2. XOR aggregation of `filemtime()` for each directory (depth 0 = only root dirs). Higher depth tracks nested directory modifications.

If fingerprint matches a persisted snapshot:
- Snapshot (APCu > CI > file) is restored without disk traversal.
- First scan counts as a miss. Subsequent restores count as hits.
- With `discoveryPreload = true`, the list is loaded early and converted into a hit on first usage (fingerprint verified once).

### Persistence Locations
| Backend | Stats Key/Path | List Key/Path |
|---------|----------------|---------------|
| File | `WRITEPATH/cache/twig/discovery-stats.json` | `discovery-stats-list.json` | 
| CI Cache | `<prefix>disc.stats` | `<prefix>disc.list` |
| APCu (optional) | `twig.discovery.list.<fingerprint>` | (in-memory only) |

### Metrics
`hits` increase when list reused in-process or restored from snapshot/APCu. `misses` increase when a filesystem scan is performed.

---
## 4. Warmup Summary
Records the most recent warmup results:
```json
{ "summary": {"compiled": 42, "skipped": 100, "errors": 0}, "all": true, "timestamp": 1734567890.123 }
```

| Backend | Location / Key |
|---------|----------------|
| File | `<cachePath>/warmup-summary.json` |
| CI Cache | `<prefix>warmup.summary` |

Used by diagnostics / CLI to show last warmup outcome without rerunning.

---
## 5. Invalidation State
Tracks:
- Last invalidation: type (single / batch / namespace), removed file count, whether environment was reinitialized, timestamp.
- Cumulative removed count across lifecycle.

| Backend | Location / Key |
|---------|----------------|
| File | `<cachePath>/invalidations.json` |
| CI Cache | `<prefix>invalidations` |

Displayed in diagnostics to monitor cache churn and potential performance issues due to frequent invalidations.

---
## 6. Prefix Derivation (CI Backend)
Config property `cachePrefix` (nullable). If `null` we derive it from `Config\Cache::$prefix` + `twig_`.
Examples:
- Global cache prefix: `app_` → Effective twig prefix: `app_twig_`
- Custom set: `$cachePrefix = 'tenant42_'` → Effective keys start with `tenant42_`

CI Key Summary (with `<prefix>` already resolved):
```
<prefix>disc.stats
<prefix>disc.list
<prefix>warmup.summary
<prefix>compile.index
<prefix>invalidations
<prefix>__index            (CICacheAdapter internal index of compiled template keys)
<prefix><sha256>           (individual compiled template entries)
```

---
## 7. Clearing Everything
Method `clearCache()` orchestrates clearing compiled artifacts. Behavior differs by backend:

| Backend | Action | Also Clears | Returns |
|---------|--------|-------------|---------|
| File | Deletes PHP files under cache dir | Nothing else (discovery stats remain unless you delete files manually) | Count of removed files |
| CI | Calls adapter clear (compiled templates & index), then deletes: disc.stats, disc.list, warmup.summary, compile.index, invalidations | Discovery stats reset via `invalidate()` | 0 (files not counted) |

To also rebuild the Twig Environment: `clearCache(true)` (forces reinitialization).

For a full fresh state in file backend you may manually remove:
```
rm -rf WRITEPATH/cache/twig
```
(Or Windows equivalent) then let Twig recreate on-demand.

---
## 8. Runtime Cache Control
API methods:
```php
$twig->disableCache();          // turns caching off (filesystem backend)
$twig->disableCache(true);      // also deletes existing compiled files
$twig->enableCache();           // re-enable default path
$twig->enableCache('/custom');  // force custom directory
$twig->isCacheEnabled();        // bool (always true for CI backend)
```
When disabled, Twig renders directly without writing compiled classes (slower per request, good for development).

---
## 9. Warmup & Compile Index Interaction
`warmup()` / `warmupAll()`:
- Loads compile index lazily.
- For each logical name: if already compiled (index OR heuristic file presence) and not forced → skip.
- On successful compilation → mark compiled + persist index.
- Summary persisted for diagnostics.

CLI examples:
```
php spark twig:warmup --all
php spark twig:warmup welcome emails/reset-password
php spark twig:warmup welcome --force
```

Force mode ensures recompilation (refresh) even if previously compiled.

---
## 10. Discovery Performance Tuning
| Option | Effect | Trade-off |
|--------|--------|-----------|
| `discoveryPersistList` | Saves list snapshot + fingerprint | Extra JSON write on first scan |
| `discoveryPreload` | Loads snapshot early each request | Additional fingerprint comparison per request |
| `discoveryUseAPCu` | Cross-process in-memory reuse (fast) | Requires APCu enabled in CLI/web SAPI |
| `discoveryFingerprintMtimeDepth` | Better change detection (subdir mtimes) | More `stat()` calls; set 1–2 if template dirs change deeply |

Common patterns:
- Production: enable `discoveryPersistList`, `discoveryPreload`, optionally `discoveryUseAPCu`, depth=0 or 1.
- Highly dynamic template trees: increase depth to 1–2.

---
## 11. Diagnostics & Introspection
`$twig->getDiagnostics()` returns a structured array including:
```php
[
  'cache' => [ 'enabled' => true, 'backend' => 'file|ci:<handler>', 'compiled_templates' => 123, ... ],
  'discovery' => [ 'hits' => 10, 'misses' => 1, 'fingerprint' => 'sha1...', 'cache_source' => 'persisted-preload', 'persistence_medium' => 'ci|file', ... ],
  'warmup' => [...],
  'invalidations' => [...],
  'persistence' => [ 'warmup' => ['medium' => 'file'], ... ],
]
```
Expose this in CLI via `twig:diagnostics` (if provided) or integrate into your own admin panel.

---
## 12. Invalidation Mechanics
Three strategies:
1. Single template → remove files containing md5(template + extension)
2. Batch → loop single strategy; aggregate
3. Namespace → derive on-disk relative paths from loader namespace paths & pattern match

After removals:
- Compile index updated (removed entries cleared)
- Invalidation state persisted
- Optional reinitialization if requested

For CI backend: compiled templates are just deleted from the key-value store; no filesystem scanning for removal.

---
## 13. Migration Notes (Switching Backends)
When switching from file → CI backend:
- Compile index is re-seeded from CI key if present.
- Discovery migration attempts to copy JSON stats/list into CI cache if CI keys aren’t yet populated (best-effort).
- Consider clearing file artifacts after validating CI backend works to avoid confusion.

---
## 14. Failure & Safety Behavior
| Scenario | Behavior |
|----------|----------|
| Missing snapshot JSON | Falls back to scan (miss) |
| Corrupt JSON payload | Ignored; treat as absent |
| APCu fetch failure | Ignore and fallback to snapshot or scan |
| CI cache handler exception | Swallowed (fails safe); file path still used for compile index unless backend='ci' |
| Fingerprint mismatch | Forces fresh scan, updates persisted fingerprint |

All persistence operations are best-effort and never throw.

---
## 15. Recommended Production Configuration
```php
$config->cacheBackend                      = 'ci';          // Redis / Memcached
$config->cachePrefix                       = null;          // derive from Config\Cache
$config->cacheTtl                          = 0;             // no expiry
$config->discoveryPersistList              = true;
$config->discoveryPreload                  = true;
$config->discoveryUseAPCu                  = true;          // if APCu available
$config->discoveryFingerprintMtimeDepth    = 0;             // or 1 if subdir changes matter
```
Run once after deployments:
```
php spark twig:warmup --all
```
Then rely on invalidation commands when templates change at runtime.

---
## 16. Quick Reference Cheatsheet
| Task | Command / API |
|------|---------------|
| Warm all templates | `php spark twig:warmup --all` |
| Warm subset force | `php spark twig:warmup email/welcome --force` |
| List templates | `php spark twig:list` |
| List with status | `php spark twig:list --status` |
| Invalidate single | `php spark twig:invalidate emails/welcome` |
| Invalidate batch | `php spark twig:invalidate:batch a b c` |
| Invalidate namespace | `php spark twig:invalidate @admin` (if command provided) |
| Clear cache only | `php spark twig:clear-cache` |
| Clear & reinit | `php spark twig:clear-cache --reinit` |
| Show stats/diagnostics | `php spark twig:diagnostics` / `twig:stats` (depending on command set) |

---
## 17. Extending / Customizing
You can:
- Wrap `TemplateDiscovery` to add custom exclusion filters.
- Implement another `Twig\Cache\CacheInterface` adapter (e.g. for S3) and assign via config.
- Add health endpoint exposing `getDiagnostics()` for monitoring.

Pull requests for new safe backends & richer diagnostics are welcome.

---
## 18. Troubleshooting
| Symptom | Cause | Resolution |
|---------|-------|-----------|
| Discovery misses always increase | Fingerprint never matches persisted snapshot | Ensure `discoveryPersistList = true`; check directory mtimes stability; lower `discoveryFingerprintMtimeDepth` |
| Warmup skips too many templates | Compile index stale after manual deletions | Run `clearCache(true)` then `warmup --all` |
| CI backend keys not appearing | Cache service misconfigured | Verify `Services::cache()` returns expected handler |
| Compiled templates keep recompiling (file backend) | Cache directory not writable | Fix permissions for `WRITEPATH/cache/twig` |
| High initial latency on first request | No warmup + discovery scan | Enable warmup or `discoveryPreload` + persist list |

---
## 19. Version Compatibility
- Twig 3.x
- CodeIgniter 4.x
- PHP 8.1+

All caching layers degrade gracefully if a feature (APCu, CI cache) is unavailable.

---
## 20. Glossary
| Term | Meaning |
|------|---------|
| Logical Template Name | Path without extension, optionally prefixed by `@namespace/` |
| Fingerprint | Stable hash representing template directory structure & mtimes |
| Compile Index | Persisted map of logical names known compiled |
| Discovery Snapshot | Serialized template list + matching fingerprint |
| Invalidation | Removal of compiled artifacts for logical templates |

---
Questions / improvements? Open an issue or PR.
